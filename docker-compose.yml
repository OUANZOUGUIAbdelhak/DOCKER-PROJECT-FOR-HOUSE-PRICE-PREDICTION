# ============================================================================
# DOCKER COMPOSE CONFIGURATION
# ============================================================================
# Purpose: Orchestrate training, API, and frontend containers locally
# Usage: docker-compose up [service_name]
# ============================================================================

services:
  
  # --------------------------------------------------------------------------
  # TRAINING SERVICE
  # --------------------------------------------------------------------------
  # Retrains the selected model using 100% of the dataset
  # Runs once, saves model to shared volume
  # --------------------------------------------------------------------------
  training:
    build:
      context: .
      dockerfile: docker_training/Dockerfile
    
    container_name: house-price-train
    
    volumes:
      # Models volume: Persist trained models on host
      - ./models:/app/models
      
      # Data volume: Access dataset from host
      - ./data:/app/data
    
    environment:
      - PYTHONUNBUFFERED=1
    
    restart: no
    
    # Override command to specify model:
    # docker-compose run --rm training --model gradient_boosting
    # docker-compose run --rm training --model neural_network
    command: ["python", "train.py", "--model", "gradient_boosting"]
  
  # --------------------------------------------------------------------------
  # API SERVICE (Inference)
  # --------------------------------------------------------------------------
  # Loads trained model from volume and serves predictions via REST API
  # Waits for training to complete before starting
  # --------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: docker_api/Dockerfile
    
    container_name: house-price-api
    
    volumes:
      # Models volume: Read trained models
      - ./models:/app/models
    
    ports:
      - "8000:8000"
    
    environment:
      - PYTHONUNBUFFERED=1
    
    restart: unless-stopped
    
    # Wait for training to complete before starting
    depends_on:
      training:
        condition: service_completed_successfully
    
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  
  # --------------------------------------------------------------------------
  # FRONTEND SERVICE
  # --------------------------------------------------------------------------
  # React UI for testing the model
  # --------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: docker_frontend/Dockerfile
    
    container_name: house-price-frontend
    
    ports:
      - "3000:80"
    
    restart: unless-stopped
    
    depends_on:
      - api
